#!/usr/bin/env python3
"""Round-trip test on arbitrary Ledger.

Read a Ledger's transactions, print them out, re-read them again and compare them.
Both sets of parsed entries should be equal.
Both printed files are output to disk, so you can also run diff on them yourself
afterwards.
"""
from os import path

from beancount import loader
from beancount.parser import printer
from beancount.core import compare


def main():
    import argparse, logging
    logging.basicConfig(level=logging.INFO, format='%(levelname)-8s: %(message)s')
    parser = argparse.ArgumentParser(__doc__.strip())
    parser.add_argument('filename', help='Beancount filename')
    opts = parser.parse_args()

    logging.info("Read the entries")
    entries, errors, options = loader.load(opts.filename, do_print_errors=True, quiet=True)

    logging.info("Print them out to a file")
    basename, extension = path.splitext(opts.filename)
    round1_filename = ''.join([basename, '.roundtrip1', extension])
    with open(round1_filename, 'w') as outfile:
        printer.print_entries(entries, outfile)

    logging.info("Read the entries from that file")
    entries_roundtrip, errors, options = loader.load(round1_filename, do_print_errors=True, quiet=True)

    logging.info("Compare the original entries with the re-read ones")
    same, missing1, missing2 = compare.compare_entries(entries, entries_roundtrip)
    if not same:
        print('Entries differ!')
        print('\n\nMissing from original:')
        printer.print_entries(missing1)
        print('\n\nMissing from round-trip:')
        printer.print_entries(missing1)

    logging.info("Print what you read to yet another file")
    round2_filename = ''.join([basename, '.roundtrip2', extension])
    with open(round2_filename, 'w') as outfile:
        printer.print_entries(entries_roundtrip, outfile)


if __name__ == '__main__':
    main()
