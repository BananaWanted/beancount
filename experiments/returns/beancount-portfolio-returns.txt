================================================================================
Calculating Portfolio Returns with Beancount
================================================================================
Martin Blais, Filippo Tampieri, August 2014

This document describes context, issues, and a method around computing the
returns of a subset of accounts in Beancount.

Problem Description
------------------------------

The calculation of one's portfolio return rate is problematic in the face of
contributions and withdrawals to and from an account. In order for one to
compare their return to the returns of an index, the dollar amount invested over
each period of time has to be considered, and the problem is that this amount
varies over time. Without a correct calculation, it is difficult to make a
meaningful comparison of the returns from one's portfolio to an ideal portfolio.

For the purpose of this discussion, we will call contributions and withdrawals
from the set of accounts under consideration "external flows." For example, if
we are considering the returns of a portfolio define by the set of accounts
under "Assets:ETrade", a transaction with one leg in
"Assets:BofA:Checking" will be considered an external flow.

Various approximation methods exist that use only the total value of a
portfolio, for example, by looking at statement of market value every month.
However, given that

1. we have the entire composition of one's portfolio around external flows, and

2. there exists a function to provide the price of any commodity at any point in
   time,

we should be able to compute the exact returns of the portfolio. The method we
use is called the "True Time Weighted Method." This method essentially computes
the returns for each time period where there is no external flow, and then we
can multiple those returns to obtain the total return of the portfolio for any
period of time. Comparison with an index's returns is then straightforward:
simply pull the index's returns over that same period of time to compare it.

In this document we describe a method to implement this in Beancount.

Basic Example
------------------------------

To illustrate the method, let's work through a basic example:

  2013-02-10 * "Open account"
    Assets:MyBank:Cash
    Assets:ScotiaBank:Cash

FIXME complete this




Parameters & Definitions
--------------------------------

The returns will be defined by categorizing all the acocunts by three sets:

1. *Asset accounts.* A set of "Assets" accounts or which we want to compute the
   returns. For example, let's assume we're computing the returns for a
   portfolio at ScotiaBank. The accounts under consideration could be all
   accounts under a common root, like this:

       Assets:ScotiaBank:Cash
       Assets:ScotiaBank:VTI
       Assets:ScotiaBank:VNQ
       Assets:ScotiaBank:LQD
       Assets:ScotiaBank:BND
       ...


2. *Related accounts.* A set of related non-assets accounts which are *not*
   considered external flows. For example, if you receive a dividend, this
   should be treated as part of the return of the account. A corresponding
   transaction could look like this:

     2014-08-01 * "Dividend payment from LQD"
       Income:ScotiaBank:Dividends  -412.34 USD
       Assets:ScotiaBank:Cash        412.34 USD

   As a matter of convention, we will assume that all Income and Expense
   accounts related to ScotiaBank also have the account name component
   "ScotiaBank" in them. For example, a related commission expense would be
   booked under "Expenses:ScotiaBank:Commissions" and is also not considered an
   external flow:

     2014-08-01 * "Bought more bonds"
       Assets:ScotiaBank:BND                 50 BND {40.00 USD}
       Assets:ScotiaBank:Cash          -2009.95 USD
       Expenses:ScotiaBank:Commissions     9.95 USD

3. *Other accounts.* The rest of all accounts. Any transactions with postings of
   an Asset account (from (1)) and one of these accounts will be considered an
   external flow. For example, a contribution might look like this:

     2014-08-01 * "Adding funds to invest"
       Assets:BofA:Cash         -3000.00 USD
       Assets:ScotiaBank:Cash    3000.00 USD

   A withdrawl (or distribution) might look like this:

     2014-08-01 * "Taking money out to pay for new car"
       Assets:ScotiaBank:Cash   -10000.00 USD
       Assets:BofA:Cash          10000.00 USD



Parameters
------------------------------

The function that will compute the portfolio return will accept two input
parameters to define the three previous sets:

1. A regular expression that defines the set of asset accounts. In our examples,
   that is "Assets:ScotiaBank:.*".

2. A regular expression that defines the set of all related accounts, including
   the asset accounts. In our examples, that is ".*:ScotiaBank:.*".

Using this, we can characterize each posting in one of the previous sets.


What is an external flow?
------------------------------

Let's examine the nature of returns a bit more closely. Our purpose is to
calculate the returns of the asset accounts. External flows are defined as
transactions with one or more postings in the set of "other accounts."

For example, if you were to sell stock an receive the proceeds directly outside
your investment account, it would look like this:

     2014-08-01 * "Sold stocks"
       Assets:ScotiaBank:VTI                -40 VTI {45.00 USD}
       Expenses:ScotiaBank:Commissions     9.95 USD
       Assets:BofA:Cash                 1990.95 USD ; External
       Income:ScotiaBank:Gains          -200.00 USD

Only the "Assets:BofA:Cash" leg is considered an external flow here. The Income
and Expenses legs are considered part of the return. We would record a negative
flow of 1990.95 USD from the account's holdings.

Generally, selling stock incurs a deposit in a cash account that sits *within*
the account and thus there is no external flow on purchases and sales:

     2014-08-01 * "Sold stocks"
       Assets:ScotiaBank:VTI                -40 VTI {45.00 USD}
       Expenses:ScotiaBank:Commissions     9.95 USD
       Assets:ScotiaBank:Cash           1990.95 USD ; Internal
       Income:ScotiaBank:Gains          -200.00 USD

When we talk of external flows, we're referring to new additions or reductions
in the assets that are being invested. We're not interested in income or
expenses if they are incurred as a result of the investing activity.

There is one case that is a little special, and that is the case of paying
taxes (we will handle this below).

Calculation Method
------------------------------

The method involves multiple steps:

1. Find all the transactions with external flows and compute the amount of these
   external flows. The time intervals between these flows define periods with no
   external flows.

2. Using the market value at the time of the transaction, compute the total
   market value of the "Asset accounts" before the transaction, and after the
   transaction.

3. For each time period without an external flow, compute the return over that
   time period as the value of the portfolio at the end of the period over the
   value of the portfolio at the beginning of the period.

4. Multiply the returns of each period in order to get the returns of the entire
   period (or any desired period).

Note that in (1) we are allowed to arbitrarily dates for which we are interested
in computing the returns, even if there are no extranal flows. The period-end
amount and period-begin amounts will just happen to have the same value. An
obvious example is inserting dates of January 1st in order to compute the
returns for particular calendar years.


Boundary Conditions
------------------------------

One problem regards how we calculate the value of the portfolio around external
flow dates, in the presence of income and expense transactions. For example, if
a transaction with an external flow includes an Expenses posting, should that
posting be applied in the previous period or in the next?

FIXME add more to this





Recognizing Taxes
------------------------------

Taxes are a bit of a thortny subject. Taxes are essentially accrued when you
realize gains and losses, and realized only when you file them (with an
associated payment). You can think as a realized gain to pay as a temporary
interest-free "loan" from the government until the time you have to file your
taxes.

When you file your taxes and pay them from an external account, which is almost
always the case, the portion of your payment that is due for capital
gains/losses is an external flow, albeit one that does not increase nor reduce
the amount of assets in your portfolio. You can view it as a contribution to
your portfolio, as you're paying out the portfolio's tax liability via your
external account instead of the investment account itself.

The question is: should taxes affect the return? It depends. We can compute two
return rates: the taxable return and the tax-free return. When you consider an
index's performance, for instance, it's a taxable return that you're looking at.
Let's work this out.

Let's take a simplified example, not considering the effect of taxes at all.
With some employement income and a single trade, we could have the following
situation:

     2013-04-01 * "Buy some ETFs"
       Assets:ScotiaBank:VTI            40 VTI {50.00 USD}
       Assets:ScotiaBank:Cash     -2000.00 USD

     2013-08-01 * "Sell some ETFs"
       Assets:ScotiaBank:VTI           -40 VTI {50.00 USD} @ 60.00 USD
       Assets:ScotiaBank:Cash      2400.00 USD
       Income:ScotiaBank:Gains     -400.00 USD

     2014-04-01 * "File and pay taxes on employment and investments"
       Assets:BofA:Checking       -4000.00 USD
       Expenses:TY2013:Federal     3000.00 USD
       Expenses:TY2013:State       1000.00 USD

To recognize taxes, we could include the portion of gains as a contribution.
Assuming a 40% tax rate on the short-term gain and replacing the last
transaction results in this:

     2014-04-01 * "File and pay taxes on employment income and investments"
       Assets:BofA:Checking       -4000.00 USD
       Expenses:ScotiaBank:Taxes    160.00 USD
       Expenses:TY2013:Federal     2880.00 USD
       Expenses:TY2013:State        960.00 USD

Or equivalently--and perhaps more explicit--like this:

     2014-04-01 * "File and pay taxes on employment income and investments"
       Assets:BofA:Checking       -4000.00 USD
       Expenses:TY2013:Federal     3000.00 USD
       Expenses:TY2013:State       1000.00 USD
       Expenses:ScotiaBank:Taxes    160.00 USD
       Expenses:TY2013:Federal     -120.00 USD
       Expenses:TY2013:State        -40.00 USD

This is a transaction that gets included in our portfolio. But the value of the
assets account does not change: until the tax filing date, we had the tax
liability on an interest-free loan, and after the filing we contributed the same
amount to our portfolio via our tax payment.

This does not affect our taxable return numbers. Inserting this transaction does
not yet provide us with a way to compute the tax-free returns.


Calculating Tax-Free Returns
------------------------------

One way to track your tax liability over the course of an investment
period is accrue them as they occur:

     2013-08-01 * "Sell some ETFs"
       Assets:ScotiaBank:VTI             -40 VTI {50.00 USD} @ 60.00 USD
       Assets:ScotiaBank:Cash        2400.00 USD
       Income:ScotiaBank:Gains       -400.00 USD
       Liabilities:ScotiaBank:Taxes  -160.00 USD
       Expenses:ScotiaBank:Taxes      160.00 USD

Inserting the last two legs is something that should be carried out
automatically by a plug-in module, which would ideally apply the tax rate
estimates suitable for your particular financialk situation.

When you file your taxes, instead of booking the taxes paid against an
"Expenses" account, you would instead reduce your tax liability to zero:

     2014-04-01 * "File and pay taxes on employment income and investments"
       Assets:BofA:Checking       -4000.00 USD
       Expenses:TY2013:Federal     3000.00 USD
       Expenses:TY2013:State       1000.00 USD
       Liability:ScotiaBank:Taxes   160.00 USD
       Expenses:TY2013:Federal     -120.00 USD
       Expenses:TY2013:State        -40.00 USD

     2014-04-02 balance Liability:ScotiaBank:Taxes  0.00 USD

With these changes, in order to calculate the tax-free returns, instead of
including only the Assets accounts in the returns calculation, you would also
want to also include balances from the Liabilities accounts. This is
straightforward. Voila!


Returns over Multiple Accounts
------------------------------

Calculating the returns over multiple account hierarchies works as well; just
specify the sets of accounts using the regular expressions. For example, if you
have accounts at multiple brokers, define the Assets accounts like this:

  "Assets:(ScotiaBank|Ameritrade|ETrade)):.*".

and the set of corresponding Related accounts like this:

  ".*:(ScotiaBank|Ameritrade|ETrade)):.*".

This should work the same.


Comparison with Internal Rate of Return
------------------------------

FIXME - TODO



Examples
------------------------------

Let's work through a few examples...
FIXME - TODO
