#!/usr/bin/env python3
"""
Parse, check and realize a beancount input file.
This also measures the time it takes to run all these steps.
"""
import argparse
import itertools

import beancount2.parser
from beancount2 import validation
from beancount2 import utils
from beancount2 import data
from beancount2 import realization


def main():
    parser = argparse.ArgumentParser(__doc__.strip())
    parser.add_argument('filename',
                        help='Beancount input filename.')
    opts = parser.parse_args()

    with utils.print_time('parse'):
        contents = beancount2.parser.parse(opts.filename)
        parse_errors = contents.parse_errors

    with utils.print_time('pad'):
        padded_entries, pad_errors = realization.pad(contents.entries)

    with utils.print_time('validation'):
        valid_errors = validation.validate(padded_entries, contents.accounts)

    with utils.print_time('realize'):
        real_accounts, real_errors = realization.realize(padded_entries, do_check=True)

    for error in itertools.chain(parse_errors,
                                 pad_errors,
                                 valid_errors,
                                 real_errors):
        print('{} {}'.format(data.render_fileloc(error.fileloc), error.message))


if __name__ == '__main__':
    main()
