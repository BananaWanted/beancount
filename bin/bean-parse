#!/usr/bin/env python
"""Main program for a parser. Try parsing using a regular parser
generator instead of crappy manual parsing. This will allow changes
to the syntax much easier, and porting to other languages easier too.
"""
import sys

from beancount.parser import parse
from os import path


def main():
    import argparse, logging
    logging.basicConfig(level=logging.INFO, format='%(levelname)-8s: %(message)s')
    parser = argparse.ArgumentParser(__doc__.strip())

    parser.add_argument('filename', help='Filename to parse')

    parser.add_argument('-l', '--lex-only', action='store_true',
                        help="Only run the lexer and print the token stream.")

    opts = parser.parse_args()

    source = open(opts.filename).read()

    lexer, parser = parse.create_parser()
    lexer.filename = path.abspath(opts.filename)
    if opts.lex_only:
        lexer.input(source)
        for tok in lexer:
            sys.stdout.write("(%s,%r,%d,%d)\n" %
                             (tok.type, tok.value, tok.lineno, tok.lexpos))
        sys.exit(1)

    result = parser.parse(source, lexer=lexer)
    if result is None:
        logging.error("Parsing error.")
        sys.exit(1)


if __name__ == '__main__':
    main()
