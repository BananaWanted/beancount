#!/usr/bin/env python
"""
Import the Excel files which can be downloaded from the RBC website. No more
Generated Source business.
"""
from StringIO import StringIO
from xml.etree import ElementTree
from collections import namedtuple


def main():
    import optparse
    parser = optparse.OptionParser(__doc__.strip())
    opts, args = parser.parse_args()
    if len(args) != 1:
        parser.error("Usage: [ACTIVITY]")
    excelfn, = args

    ss = 'urn:schemas-microsoft-com:office:spreadsheet'

    doc = ElementTree.parse(excelfn)
    rows = doc.findall('.//{%s}Row' % ss)

    header = rows[0]
    fields = []
    for i, cell in enumerate(header.findall('.//{%s}Cell' % ss)):
        data = cell.find('.//{%s}Data' % ss)
        fields.append(data.text)
        ## print ElementTree.tostring(data)
    Row = namedtuple('Row', fields)

    for row in reversed(rows[1:]):
        r = Row(*[cell.find('.//{%s}Data' % ss).text
                  for cell in row.findall('.//{%s}Cell' % ss)])

        s = StringIO()
        if r.Settlement != r.Date:
            s.write('%s=%s' % (r.Settlement, r.Date))
        else:
            s.write(r.Date)
        s.write(' ! %s -- %s -- %s' % (r.Action, r.Symbol, r.Description))
        print s.getvalue()


if __name__ == '__main__':
    main()
