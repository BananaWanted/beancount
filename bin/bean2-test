#!/usr/bin/env python3
"""Various tests for beancount2.
(This is the main test program I fiddle with during development.)
"""
import argparse
from collections import defaultdict

import beancount2.parser
from beancount2.parser import *


#-------------------------------------------------------------------------------

def get_account_type(account):
    return account.name.split(':')[0]

def is_balance_sheet_account(account):
    return get_account_type(account) in ('Assets', 'Liabilities', 'Equity')



#-------------------------------------------------------------------------------


def main():
    parser = argparse.ArgumentParser(__doc__.strip())

    parser.add_argument('filename',
                        help='Beancount input filename.')
    parser.add_argument('-v', '--verbose', action='store_true',
                        help="Print out verbose information")

    parser.add_argument('-l', '--dump-lexer', action='store_true',
                        help="Run the lexer only, output the tags.")

    opts = parser.parse_args()

    if opts.dump_lexer:
        beancount2.parser.lexer_dump(opts.filename, sys.stdout)
        return
    
    entries = beancount2.parser.parse(opts.filename)

    if opts.verbose:
        for txn in entries:
            print(txn)
    entries.sort(key=lambda x: x.date)

    # print_tags(entries)


def print_locations(entries):
    for e in entries:
        if isinstance(e, Event) and e.type == 'location':
            print (e)


def print_open_close(entries):

    accmap = defaultdict(list)
    for e in entries:
        if isinstance(e, (Open, Close)):
            accmap[e.account].append(e)

    for account, openclose in accmap.items():
        if is_balance_sheet_account(account):
            print(account)
            for e in openclose:
                print('  ', e)


def print_tags(entries):

    tagsmap = defaultdict(list)
    for e in entries:
        if isinstance(e, Transaction):
            for tag in e.tags:
                tagsmap[tag].append(e)

    for tag, entry_list in tagsmap.items():
        print
        print(tag)
        for e in entry_list:
            print('  ', e)



if __name__ == '__main__':
    main()
